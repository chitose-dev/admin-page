<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTsãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ  - ç®¡ç†ç”»é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #000000;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            border: 2px solid #000;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #000;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .btn {
            padding: 10px 20px;
            background: #000;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn:hover {
            background: #333;
        }

        .btn-secondary {
            background: #fff;
            color: #000;
            border: 1px solid #000;
        }

        .btn-secondary:hover {
            background: #f0f0f0;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-copy {
            background: #007bff;
            margin-left: 10px;
        }

        .btn-copy:hover {
            background: #0056b3;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .main-container {
            display: none;
        }

        .main-container.active {
            display: flex;
            min-height: 100vh;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 250px;
            background: #000;
            color: #fff;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #333;
        }

        .sidebar-header h2 {
            font-size: 18px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-menu li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sidebar-menu li:hover {
            background: #333;
        }

        .sidebar-menu li.active {
            background: #fff;
            color: #000;
        }

        .logout-btn {
            margin: 20px;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 200;
            background: #000;
            color: #fff;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 24px;
            transition: opacity 0.3s ease;
        }

        .hamburger:hover {
            background: #333;
        }

        .hamburger.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content {
            margin-left: 250px;
            padding: 30px;
            flex: 1;
        }

        .content-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .content-header h1 {
            font-size: 28px;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: #fff;
            border: 1px solid #000;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .card-header h2 {
            font-size: 20px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #000;
            color: #fff;
            font-weight: 600;
        }

        table tr:hover {
            background: #f5f5f5;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn.active {
            background: #000;
            color: #fff;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border: 2px solid #000;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .modal-header h2 {
            font-size: 22px;
        }

        .close-btn {
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            border: none;
            background: none;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ãƒãƒƒã‚¸ */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #000;
        }

        .badge-pending {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .badge-approved {
            background: #d4edda;
            border-color: #28a745;
        }

        .badge-rejected {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .badge-cancelled {
            background: #e2e3e5;
            border-color: #6c757d;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-btns {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        /* ãƒ—ãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ */
        .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .plan-card {
            border: 2px solid #000;
            padding: 20px;
        }

        .plan-card h3 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .plan-details {
            margin: 15px 0;
        }

        .plan-details p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .plan-details strong {
            font-weight: 600;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* API URLè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .api-url-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }

        .api-url-box p {
            margin-bottom: 10px;
            font-weight: 600;
        }

        .url-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .url-text {
            flex: 1;
            padding: 8px;
            background: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
                padding: 80px 20px 30px;
            }

            .main-container {
                flex-direction: column;
            }

            .plan-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-btn {
                width: 100%;
            }

            table {
                font-size: 12px;
            }

            table th,
            table td {
                padding: 8px;
            }

            .modal-content {
                padding: 20px;
            }

            .url-display {
                flex-direction: column;
            }
        }

        .hidden {
            display: none;
        }

        .info-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            width: 150px;
        }

        .info-value {
            flex: 1;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-top: 10px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>ç®¡ç†ç”»é¢ãƒ­ã‚°ã‚¤ãƒ³</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                    <input type="text" id="loginId" required>
                </div>
                <div class="form-group">
                    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div id="loginError" class="error-message hidden"></div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç®¡ç†ç”»é¢ -->
    <div id="mainScreen" class="main-container">
        <!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
        <button class="hamburger" id="hamburgerBtn">â˜°</button>

        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="mobile-overlay" id="mobileOverlay"></div>

        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ç®¡ç†ç”»é¢</h2>
            </div>
            <ul class="sidebar-menu" id="sidebarMenu">
                <li data-page="applications" class="active">ç”³è«‹è€…ç®¡ç†</li>
                <li data-page="plans">ãƒ—ãƒ©ãƒ³ç®¡ç†</li>
                <li data-page="history">é€ä¿¡å±¥æ­´</li>
                <li data-page="manual-send">æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡</li>
                <li data-page="settings">è¨­å®š</li>
            </ul>
            <button class="btn logout-btn" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div class="content">
            <!-- ç”³è«‹è€…ç®¡ç† -->
            <div id="applications" class="page-content">
                <div class="content-header">
                    <h1>ç”³è«‹è€…ç®¡ç†</h1>
                </div>
                <div class="card">
                    <div class="filters" id="statusFilters">
                        <button class="filter-btn active" data-status="all">å…¨ã¦</button>
                        <button class="filter-btn" data-status="pending">æ‰¿èªå¾…ã¡</button>
                        <button class="filter-btn" data-status="approved">æ‰¿èªæ¸ˆã¿</button>
                        <button class="filter-btn" data-status="rejected">å´ä¸‹</button>
                        <button class="filter-btn" data-status="cancelled">è§£ç´„æ¸ˆã¿</button>
                    </div>
                    <div class="table-container">
                        <table id="applicationsTable">
                            <thead>
                                <tr>
                                    <th>ä¼šå“¡ç•ªå·</th>
                                    <th>æ°å</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>ãƒ—ãƒ©ãƒ³</th>
                                    <th>ç”³è«‹æ—¥</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ©ãƒ³ç®¡ç† -->
            <div id="plans" class="page-content hidden">
                <div class="content-header">
                    <h1>ãƒ—ãƒ©ãƒ³ç®¡ç†</h1>
                </div>
                <button class="btn" id="addPlanBtn" style="margin-bottom: 20px;">æ–°è¦ãƒ—ãƒ©ãƒ³è¿½åŠ </button>
                <div class="plan-grid" id="planGrid"></div>
            </div>

            <!-- é€ä¿¡å±¥æ­´ -->
            <div id="history" class="page-content hidden">
                <div class="content-header">
                    <h1>ãƒ¡ãƒ¼ãƒ«é€ä¿¡å±¥æ­´</h1>
                </div>
                <div class="card">
                    <div class="form-group" style="max-width: 300px; margin-bottom: 20px;">
                        <label>æ—¥ä»˜çµã‚Šè¾¼ã¿</label>
                        <input type="date" id="historyDateFilter">
                    </div>
                    <div class="table-container">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th>é€ä¿¡æ—¥æ™‚</th>
                                    <th>ãƒ—ãƒ©ãƒ³</th>
                                    <th>é€ä¿¡æ•°</th>
                                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡ -->
            <div id="manual-send" class="page-content hidden">
                <div class="content-header">
                    <h1>æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡</h1>
                </div>
                <div class="card">
                    <form id="manualSendForm">
                        <div class="form-group">
                            <label>å¯¾è±¡ãƒ—ãƒ©ãƒ³</label>
                            <select id="manualSendPlan" required></select>
                        </div>
                        <div class="form-group">
                            <label>ä»¶å</label>
                            <input type="text" id="manualSendSubject" required>
                            <small>å¤‰æ•°: {name-l}=å§“, {name-f}=å, {birthday}=ç”Ÿå¹´æœˆæ—¥, {today}=ä»Šæ—¥ã®æ—¥ä»˜(YYYY-MM-DD)</small>
                        </div>
                        <div class="form-group">
                            <label>æœ¬æ–‡</label>
                            <textarea id="manualSendBody" required placeholder="å¤‰æ•°: {name-l}=å§“, {name-f}=å, {birthday}=ç”Ÿå¹´æœˆæ—¥, {today}=ä»Šæ—¥ã®æ—¥ä»˜(YYYY-MM-DD)"></textarea>
                        </div>
                        <button type="submit" class="btn">é€ä¿¡</button>
                    </form>
                </div>
            </div>

            <!-- è¨­å®š -->
            <div id="settings" class="page-content hidden">
                <div class="content-header">
                    <h1>è¨­å®š</h1>
                </div>
                
                <div class="card">
                    <h2>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
                    <form id="passwordChangeForm">
                        <div class="form-group">
                            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                            <input type="text" id="changePasswordUserId" required>
                        </div>
                        <div class="form-group">
                            <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div id="passwordChangeMessage" class="hidden"></div>
                        <button type="submit" class="btn">å¤‰æ›´</button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
                        <button class="btn" id="addStaffBtn">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </button>
                    </div>
                    <div class="table-container">
                        <table id="staffTable">
                            <thead>
                                <tr>
                                    <th>æ°å</th>
                                    <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”³è«‹è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="applicationDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç”³è«‹è€…è©³ç´°</h2>
                <button class="close-btn" id="closeAppDetailBtn">&times;</button>
            </div>
            <div class="modal-body" id="applicationDetailBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeAppDetailBtn2">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ©ãƒ³è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="planModalTitle">ãƒ—ãƒ©ãƒ³è¿½åŠ </h2>
                <button class="close-btn" id="closePlanModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planId">
                    <div class="form-group">
                        <label>ãƒ—ãƒ©ãƒ³å</label>
                        <input type="text" id="planName" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ™‚åˆ»</label>
                        <input type="time" id="planSendTime" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ä»¶åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                        <input type="text" id="planEmailSubject" required placeholder="ä¾‹: ã€{name-l}æ§˜ã€‘æœ¬æ—¥ã®ãŠçŸ¥ã‚‰ã›">
                        <small>å¤‰æ•°: {name-l}=å§“, {name-f}=å, {birthday}=ç”Ÿå¹´æœˆæ—¥, {today}=ä»Šæ—¥ã®æ—¥ä»˜(YYYY-MM-DD)</small>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                        <textarea id="planEmailBody" required placeholder="ä¾‹: {name-l}{name-f}æ§˜&#10;&#10;æœ¬æ—¥({today})ã®é…ä¿¡å†…å®¹ã§ã™ã€‚&#10;&#10;{{content}}"></textarea>
                        <small>å¤‰æ•°: {name-l}=å§“, {name-f}=å, {birthday}=ç”Ÿå¹´æœˆæ—¥, {today}=ä»Šæ—¥ã®æ—¥ä»˜(YYYY-MM-DD), {{content}}=GPTsç”Ÿæˆå†…å®¹</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closePlanModalBtn2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" id="savePlanBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ©ãƒ³è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="planDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="planDetailTitle">ãƒ—ãƒ©ãƒ³è©³ç´°</h2>
                <button class="close-btn" id="closePlanDetailBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="planDetailInfo" style="margin-bottom: 20px;"></div>
                
                <!-- GPTsç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—URL -->
                <div class="api-url-box">
                    <p>ğŸ“‹ GPTsç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—URL</p>
                    <div class="url-display">
                        <div class="url-text" id="planDataUrl">-</div>
                        <button class="btn btn-copy" onclick="copyPlanUrl()">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <small style="display: block; margin-top: 10px; color: #666;">
                        ã“ã®URLã‚’GPTsã®Actionsã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ãƒ³åŠ å…¥è€…ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚<br>
                        JSONå½¢å¼: /api/public/plan-data/{planId}<br>
                        TXTå½¢å¼: /api/public/plan-data/{planId}?format=txt
                    </small>
                </div>
                
                <h3 style="margin: 25px 0 15px; padding-bottom: 10px; border-bottom: 2px solid #000;">åŠ å…¥è€…ä¸€è¦§</h3>
                
                <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                    <label>æ¤œç´¢ï¼ˆåå‰ãƒ»ä¼šå“¡ç•ªå·ï¼‰</label>
                    <input type="text" id="planCustomerSearch" placeholder="å±±ç”°å¤ªéƒ ã¾ãŸã¯ NOTE-2024-0001">
                </div>
                
                <div class="table-container">
                    <table id="planCustomersTable">
                        <thead>
                            <tr>
                                <th>ä¼šå“¡ç•ªå·</th>
                                <th>æ°å</th>
                                <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                <th>ç™»éŒ²æ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="editPlanFromDetail()" id="editPlanFromDetailBtn">ç·¨é›†</button>
                <button class="btn btn-secondary" id="closePlanDetailBtn2">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="staffModalTitle">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h2>
                <button class="close-btn" id="closeStaffModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId">
                    <div class="form-group">
                        <label>æ°å</label>
                        <input type="text" id="staffName" required>
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="staffEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeStaffModalBtn2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" id="saveStaffBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®š
        // ========================================
        const API_BASE_URL = 'https://gpts-email-system-460540063355.asia-northeast1.run.app';
        
        // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
        let authToken = localStorage.getItem('authToken') || null;
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentFilter = 'all';
        let currentPlanId = null;

        // ========================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ========================================
        
        // APIå‘¼ã³å‡ºã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
        async function apiCall(endpoint, method = 'GET', data = null, requireAuth = true) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (requireAuth && authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const options = {
                method: method,
                headers: headers
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (response.status === 401) {
                    // èªè¨¼ã‚¨ãƒ©ãƒ¼ - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    logout();
                    throw new Error('èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getStatusText(status) {
            const statusMap = {
                'pending': 'æ‰¿èªå¾…ã¡',
                'approved': 'æ‰¿èªæ¸ˆã¿',
                'rejected': 'å´ä¸‹',
                'cancelled': 'è§£ç´„æ¸ˆã¿'
            };
            return statusMap[status] || status;
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('loginForm').reset();
        }

        // ãƒ—ãƒ©ãƒ³URLã‚³ãƒ”ãƒ¼
        function copyPlanUrl() {
            const urlText = document.getElementById('planDataUrl').textContent;
            navigator.clipboard.writeText(urlText).then(() => {
                alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // ========================================
        // èªè¨¼
        // ========================================
        
        // ãƒ­ã‚°ã‚¤ãƒ³
        async function handleLogin(event) {
            event.preventDefault();
            
            const userId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
            
            try {
                const response = await apiCall('/api/auth/login', 'POST', {
                    userId: userId,
                    password: password
                }, false);
                
                authToken = response.token;
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').classList.add('active');
                loadApplications();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const userId = document.getElementById('changePasswordUserId').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const messageDiv = document.getElementById('passwordChangeMessage');
            
            messageDiv.classList.add('hidden');
            messageDiv.textContent = '';
            
            try {
                await apiCall('/api/auth/change-password', 'POST', {
                    userId: userId,
                    currentPassword: currentPassword,
                    newPassword: newPassword
                });
                
                messageDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ';
                messageDiv.className = 'success-message';
                document.getElementById('passwordChangeForm').reset();
            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'error-message';
            }
        }

        // ========================================
        // ç”³è«‹è€…ç®¡ç†
        // ========================================
        
        // ç”³è«‹è€…ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadApplications(filterStatus = 'all') {
            currentFilter = filterStatus;
            const tbody = document.querySelector('#applicationsTable tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                const queryParam = filterStatus !== 'all' ? `?status=${filterStatus}` : '';
                const applications = await apiCall(`/api/applications${queryParam}`);
                
                tbody.innerHTML = '';
                
                if (applications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ç”³è«‹è€…ãŒã„ã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                applications.forEach(app => {
                    const tr = document.createElement('tr');
                    tr.style.cursor = 'pointer';
                    
                    let actionButtons = '';
                    if (app.status === 'pending') {
                        actionButtons = `
                            <button class="action-btn" onclick="updateApplicationStatus('${app.id}', 'approved')">æ‰¿èª</button>
                            <button class="action-btn" onclick="updateApplicationStatus('${app.id}', 'rejected')">å´ä¸‹</button>
                        `;
                    } else if (app.status === 'rejected') {
                        actionButtons = `
                            <button class="action-btn" onclick="updateApplicationStatus('${app.id}', 'approved')">æ‰¿èª</button>
                        `;
                    } else if (app.status === 'approved') {
                        actionButtons = `
                            <button class="action-btn btn-danger" onclick="cancelSubscription('${app.id}')">è§£ç´„</button>
                        `;
                    }
                    
                    const fullName = `${app.lastName || ''} ${app.firstName || ''}`;
                    
                    tr.innerHTML = `
                        <td>${app.memberNumber}</td>
                        <td>${fullName}</td>
                        <td><span class="badge badge-${app.status}">${getStatusText(app.status)}</span></td>
                        <td>${app.plan}</td>
                        <td>${app.appliedDate}</td>
                        <td class="action-btns" onclick="event.stopPropagation()">
                            ${actionButtons}
                        </td>
                    `;
                    tr.onclick = function() { showApplicationDetail(app.id); };
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // ç”³è«‹è€…è©³ç´°è¡¨ç¤º
        async function showApplicationDetail(id) {
            try {
                const app = await apiCall(`/api/applications/${id}`);
                
                const detailBody = document.getElementById('applicationDetailBody');
                const fullName = `${app.lastName || ''} ${app.firstName || ''}`;
                
                detailBody.innerHTML = `
                    <div class="info-row">
                        <div class="info-label">ä¼šå“¡ç•ªå·:</div>
                        <div class="info-value">${app.memberNumber}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">æ°å:</div>
                        <div class="info-value">${fullName}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">å§“:</div>
                        <div class="info-value">${app.lastName || ''}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">å:</div>
                        <div class="info-value">${app.firstName || ''}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ç”Ÿå¹´æœˆæ—¥:</div>
                        <div class="info-value">${app.birthDate}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</div>
                        <div class="info-value">${app.email}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ãƒ—ãƒ©ãƒ³:</div>
                        <div class="info-value">${app.plan}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</div>
                        <div class="info-value"><span class="badge badge-${app.status}">${getStatusText(app.status)}</span></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ç”³è«‹æ—¥:</div>
                        <div class="info-value">${app.appliedDate}</div>
                    </div>
                    ${app.lastSendDate ? `
                    <div class="info-row">
                        <div class="info-label">æœ€çµ‚é€ä¿¡æ—¥:</div>
                        <div class="info-value">${app.lastSendDate}</div>
                    </div>
                    ` : ''}
                `;
                document.getElementById('applicationDetailModal').classList.add('active');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ç”³è«‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        async function updateApplicationStatus(id, newStatus) {
            try {
                await apiCall(`/api/applications/${id}/status`, 'PUT', {
                    status: newStatus
                });
                
                loadApplications(currentFilter);
                alert(`ç”³è«‹ã‚’${getStatusText(newStatus)}ã—ã¾ã—ãŸ`);
            } catch (error) {
                alert(error.message);
            }
        }
        
        // è§£ç´„å‡¦ç†
        async function cancelSubscription(id) {
            const lastSendDate = prompt('æœ€çµ‚é€ä¿¡æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰:');
            
            if (!lastSendDate) {
                return;
            }
            
            const datePattern = /^\d{4}-\d{2}-\d{2}$/;
            if (!datePattern.test(lastSendDate)) {
                alert('æ—¥ä»˜ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚YYYY-MM-DDå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                await apiCall(`/api/applications/${id}/status`, 'PUT', {
                    status: 'cancelled',
                    lastSendDate: lastSendDate
                });
                
                if (document.getElementById('planDetailModal').classList.contains('active')) {
                    loadPlanCustomers(currentPlanId);
                }
                
                loadApplications(currentFilter);
                alert(`è§£ç´„å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æœ€çµ‚é€ä¿¡æ—¥: ${lastSendDate}`);
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // ãƒ—ãƒ©ãƒ³ç®¡ç†
        // ========================================
        let isSavingPlan = false;
        
        // ãƒ—ãƒ©ãƒ³ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadPlans() {
            const planGrid = document.getElementById('planGrid');
            planGrid.innerHTML = '<p style="padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            try {
                const plans = await apiCall('/api/plans');
                
                planGrid.innerHTML = '';
                
                if (plans.length === 0) {
                    planGrid.innerHTML = '<p style="padding: 20px;">ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                plans.forEach(plan => {
                    const planCard = document.createElement('div');
                    planCard.className = 'plan-card';
                    planCard.style.cursor = 'pointer';
                    
                    const subjectPreview = plan.emailSubject ? plan.emailSubject.substring(0, 50) : '-';
                    const bodyPreview = plan.emailBody ? plan.emailBody.substring(0, 80) : '-';
                    
                    planCard.innerHTML = `
                        <h3>${plan.name}</h3>
                        <div class="plan-details">
                            <p><strong>ãƒ—ãƒ©ãƒ³ID:</strong> ${plan.planId || '-'}</p>
                            <p><strong>é€ä¿¡æ™‚åˆ»:</strong> ${plan.sendTime}</p>
                            <p><strong>ä»¶å:</strong></p>
                            <p style="font-size: 13px; color: #666;">${subjectPreview}...</p>
                            <p style="margin-top: 10px;"><strong>æœ¬æ–‡:</strong></p>
                            <p style="font-size: 13px; color: #666;">${bodyPreview}...</p>
                        </div>
                        <div class="plan-actions">
                            <button class="btn" onclick="event.stopPropagation(); showPlanDetail('${plan.id}')" style="background: #007bff;">è©³ç´°</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deletePlan('${plan.id}')">å‰Šé™¤</button>
                        </div>
                    `;
                    planCard.onclick = function() { showPlanDetail(plan.id); };
                    planGrid.appendChild(planCard);
                });
            } catch (error) {
                planGrid.innerHTML = `<p style="padding: 20px; color: #dc3545;">${error.message}</p>`;
            }
        }
        
        // ãƒ—ãƒ©ãƒ³è©³ç´°è¡¨ç¤º
        async function showPlanDetail(planId) {
            try {
                const plan = await apiCall(`/api/plans/${planId}`);
                
                currentPlanId = planId;
                
                document.getElementById('planDetailTitle').textContent = `${plan.name} - è©³ç´°`;
                
                const planDetailInfo = document.getElementById('planDetailInfo');
                planDetailInfo.innerHTML = `
                    <div class="info-row">
                        <div class="info-label">ãƒ—ãƒ©ãƒ³å:</div>
                        <div class="info-value">${plan.name}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ãƒ—ãƒ©ãƒ³ID:</div>
                        <div class="info-value" style="font-family: monospace;">${plan.planId || 'æœªç”Ÿæˆ'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">é€ä¿¡æ™‚åˆ»:</div>
                        <div class="info-value">${plan.sendTime}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ä»¶åãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</div>
                        <div class="info-value">${plan.emailSubject || '-'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">æœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</div>
                        <div class="info-value" style="white-space: pre-wrap;">${plan.emailBody || '-'}</div>
                    </div>
                `;
                
                // GPTsç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—URLã‚’è¡¨ç¤º
                if (plan.planId) {
                    const dataUrl = `${API_BASE_URL}/api/public/plan-data/${plan.planId}`;
                    document.getElementById('planDataUrl').textContent = dataUrl;
                } else {
                    document.getElementById('planDataUrl').textContent = 'ãƒ—ãƒ©ãƒ³IDãŒæœªç”Ÿæˆã§ã™';
                }
                
                loadPlanCustomers(planId);
                
                document.getElementById('planDetailModal').classList.add('active');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ãƒ—ãƒ©ãƒ³åŠ å…¥è€…ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadPlanCustomers(planId, searchQuery = '') {
            const tbody = document.querySelector('#planCustomersTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                const queryParam = searchQuery ? `?search=${encodeURIComponent(searchQuery)}` : '';
                const subscribers = await apiCall(`/api/plans/${planId}/subscribers${queryParam}`);
                
                tbody.innerHTML = '';
                
                if (subscribers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">è©²å½“ã™ã‚‹åŠ å…¥è€…ãŒã„ã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                subscribers.forEach(customer => {
                    const tr = document.createElement('tr');
                    const fullName = `${customer.lastName || ''} ${customer.firstName || ''}`;
                    
                    tr.innerHTML = `
                        <td>${customer.memberNumber}</td>
                        <td>${fullName}</td>
                        <td>${customer.email}</td>
                        <td>${customer.appliedDate}</td>
                        <td>
                            <button class="action-btn btn-danger" onclick="cancelSubscription('${customer.id}')">è§£ç´„</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // ãƒ—ãƒ©ãƒ³è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showAddPlanModal() {
            document.getElementById('planModalTitle').textContent = 'ãƒ—ãƒ©ãƒ³è¿½åŠ ';
            document.getElementById('planForm').reset();
            document.getElementById('planId').value = '';
            document.getElementById('planModal').classList.add('active');
        }
        
        // ãƒ—ãƒ©ãƒ³ç·¨é›†
        async function editPlan(id) {
            try {
                const plan = await apiCall(`/api/plans/${id}`);
                
                document.getElementById('planModalTitle').textContent = 'ãƒ—ãƒ©ãƒ³ç·¨é›†';
                document.getElementById('planId').value = plan.id;
                document.getElementById('planName').value = plan.name;
                document.getElementById('planSendTime').value = plan.sendTime;
                document.getElementById('planEmailSubject').value = plan.emailSubject || '';
                document.getElementById('planEmailBody').value = plan.emailBody || '';
                document.getElementById('planModal').classList.add('active');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ãƒ—ãƒ©ãƒ³è©³ç´°ã‹ã‚‰ç·¨é›†
        function editPlanFromDetail() {
            if (currentPlanId) {
                document.getElementById('planDetailModal').classList.remove('active');
                editPlan(currentPlanId);
            }
        }
        
        // ãƒ—ãƒ©ãƒ³ä¿å­˜
        async function savePlan() {
            // é€£æ‰“é˜²æ­¢ãƒã‚§ãƒƒã‚¯
            if (isSavingPlan) {
                console.log('æ—¢ã«ä¿å­˜å‡¦ç†ä¸­ã§ã™');
                return;
            }
    
            const id = document.getElementById('planId').value;
            const name = document.getElementById('planName').value;
            const sendTime = document.getElementById('planSendTime').value;
            const emailSubject = document.getElementById('planEmailSubject').value;
            const emailBody = document.getElementById('planEmailBody').value;

            if (!name || !sendTime || !emailSubject || !emailBody) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ä¿å­˜ä¸­ãƒ•ãƒ©ã‚°ã‚’ON
            isSavingPlan = true;
    
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const saveBtn = document.getElementById('savePlanBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.disabled = true;
            saveBtn.classList.add('loading');

            try {
                if (id) {
                    await apiCall(`/api/plans/${id}`, 'PUT', {
                        name, sendTime, emailSubject, emailBody
                    });
                } else {
                    await apiCall('/api/plans', 'POST', {
                        name, sendTime, emailSubject, emailBody
                    });
                }
        
                document.getElementById('planModal').classList.remove('active');
                loadPlans();
                alert('ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                alert(error.message);
            } finally {
                // ä¿å­˜ä¸­ãƒ•ãƒ©ã‚°ã‚’OFF
                isSavingPlan = false;
        
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
            }
        }
        
        // ãƒ—ãƒ©ãƒ³å‰Šé™¤
        async function deletePlan(id) {
            if (!confirm('ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) {
                return;
            }
            
            try {
                await apiCall(`/api/plans/${id}`, 'DELETE');
                loadPlans();
                alert('ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // é€ä¿¡å±¥æ­´
        // ========================================
        
        // é€ä¿¡å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadHistory(filterDate = null) {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                const queryParam = filterDate ? `?date=${filterDate}` : '';
                const history = await apiCall(`/api/history${queryParam}`);
                
                tbody.innerHTML = '';
                
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                history.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.plan}</td>
                        <td>${item.count}ä»¶</td>
                        <td>${item.status}</td>
                        <td>
                            <button class="action-btn btn-danger" onclick="deleteHistory('${item.id}')">å‰Šé™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // å±¥æ­´å‰Šé™¤
        async function deleteHistory(id) {
            if (!confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) {
                return;
            }
            
            try {
                await apiCall(`/api/history/${id}`, 'DELETE');
                loadHistory();
                alert('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        // ========================================
        
        // æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç”»é¢èª­ã¿è¾¼ã¿
        async function loadManualSend() {
            const select = document.getElementById('manualSendPlan');
            select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
            
            try {
                const plans = await apiCall('/api/plans');
                
                select.innerHTML = '';
                
                if (plans.length === 0) {
                    select.innerHTML = '<option value="">ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</option>';
                    return;
                }
                
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = plan.name;
                    select.appendChild(option);
                });
            } catch (error) {
                select.innerHTML = `<option value="">ã‚¨ãƒ©ãƒ¼: ${error.message}</option>`;
            }
        }
        
        // æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        async function handleManualSend(event) {
            event.preventDefault();
            
            const planId = document.getElementById('manualSendPlan').value;
            const subject = document.getElementById('manualSendSubject').value;
            const body = document.getElementById('manualSendBody').value;
            
            if (!confirm('é¸æŠã—ãŸãƒ—ãƒ©ãƒ³ã®å…¨åŠ å…¥è€…ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã‹?')) {
                return;
            }
            
            try {
                const result = await apiCall('/api/send-manual', 'POST', {
                    planId, subject, body
                });
                
                alert(result.message);
                document.getElementById('manualSendForm').reset();
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // è¨­å®š
        // ========================================
        
        // è¨­å®šèª­ã¿è¾¼ã¿
        async function loadSettings() {
            try {
                await loadStaff();
            } catch (error) {
                console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadStaff() {
            const tbody = document.querySelector('#staffTable tbody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                const staff = await apiCall('/api/staff');
                
                tbody.innerHTML = '';
                
                if (staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
                    return;
                }
                
                staff.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${s.name}</td>
                        <td>${s.email}</td>
                        <td class="action-btns">
                            <button class="action-btn" onclick="editStaff('${s.id}')">ç·¨é›†</button>
                            <button class="action-btn btn-danger" onclick="deleteStaff('${s.id}')">å‰Šé™¤</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showAddStaffModal() {
            document.getElementById('staffModalTitle').textContent = 'ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ';
            document.getElementById('staffForm').reset();
            document.getElementById('staffId').value = '';
            document.getElementById('staffModal').classList.add('active');
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†
        async function editStaff(id) {
            try {
                const staff = await apiCall('/api/staff');
                const member = staff.find(s => s.id === id);
                
                if (member) {
                    document.getElementById('staffModalTitle').textContent = 'ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†';
                    document.getElementById('staffId').value = member.id;
                    document.getElementById('staffName').value = member.name;
                    document.getElementById('staffEmail').value = member.email;
                    document.getElementById('staffModal').classList.add('active');
                }
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•ä¿å­˜
        async function saveStaff() {
            const id = document.getElementById('staffId').value;
            const name = document.getElementById('staffName').value;
            const email = document.getElementById('staffEmail').value;

            if (!name || !email) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                if (id) {
                    await apiCall(`/api/staff/${id}`, 'PUT', { name, email });
                } else {
                    await apiCall('/api/staff', 'POST', { name, email });
                }
                
                document.getElementById('staffModal').classList.remove('active');
                loadStaff();
                alert('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤
        async function deleteStaff(id) {
            if (!confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) {
                return;
            }
            
            try {
                await apiCall(`/api/staff/${id}`, 'DELETE');
                loadStaff();
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        
        function switchPage(pageName) {
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(pageName).classList.remove('hidden');

            switch(pageName) {
                case 'applications':
                    loadApplications();
                    break;
                case 'plans':
                    loadPlans();
                    break;
                case 'history':
                    loadHistory();
                    break;
                case 'manual-send':
                    loadManualSend();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯
            if (authToken) {
                // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').classList.add('active');
                loadApplications();
            }
            
            // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');

            hamburgerBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                hamburgerBtn.classList.toggle('hidden');
            });

            mobileOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                mobileOverlay.classList.remove('active');
                hamburgerBtn.classList.remove('hidden');
            });

            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            document.querySelectorAll('#sidebarMenu li').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    switchPage(page);
                    
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                        mobileOverlay.classList.remove('active');
                        hamburgerBtn.classList.remove('hidden');
                    }
                });
            });

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹?')) {
                    logout();
                }
            });

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
            document.getElementById('passwordChangeForm').addEventListener('submit', handlePasswordChange);

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
            document.querySelectorAll('#statusFilters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#statusFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadApplications(this.getAttribute('data-status'));
                });
            });

            // ãƒ—ãƒ©ãƒ³é–¢é€£
            document.getElementById('addPlanBtn').addEventListener('click', showAddPlanModal);
            document.getElementById('savePlanBtn').addEventListener('click', savePlan);
            document.getElementById('closePlanModalBtn').addEventListener('click', function() {
                document.getElementById('planModal').classList.remove('active');
            });
            document.getElementById('closePlanModalBtn2').addEventListener('click', function() {
                document.getElementById('planModal').classList.remove('active');
            });

            // ç”³è«‹è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('closeAppDetailBtn').addEventListener('click', function() {
                document.getElementById('applicationDetailModal').classList.remove('active');
            });
            document.getElementById('closeAppDetailBtn2').addEventListener('click', function() {
                document.getElementById('applicationDetailModal').classList.remove('active');
            });

            // ãƒ—ãƒ©ãƒ³è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('closePlanDetailBtn').addEventListener('click', function() {
                document.getElementById('planDetailModal').classList.remove('active');
            });
            document.getElementById('closePlanDetailBtn2').addEventListener('click', function() {
                document.getElementById('planDetailModal').classList.remove('active');
            });

            // ãƒ—ãƒ©ãƒ³åŠ å…¥è€…æ¤œç´¢
            document.getElementById('planCustomerSearch').addEventListener('input', function() {
                if (currentPlanId) {
                    loadPlanCustomers(currentPlanId, this.value);
                }
            });

            // ã‚¹ã‚¿ãƒƒãƒ•é–¢é€£
            document.getElementById('addStaffBtn').addEventListener('click', showAddStaffModal);
            document.getElementById('saveStaffBtn').addEventListener('click', saveStaff);
            document.getElementById('closeStaffModalBtn').addEventListener('click', function() {
                document.getElementById('staffModal').classList.remove('active');
            });
            document.getElementById('closeStaffModalBtn2').addEventListener('click', function() {
                document.getElementById('staffModal').classList.remove('active');
            });

            // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            document.getElementById('historyDateFilter').addEventListener('change', function() {
                loadHistory(this.value);
            });

            // æ‰‹å‹•ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            document.getElementById('manualSendForm').addEventListener('submit', handleManualSend);
        });
    </script>
</body>
</html>
