<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTsメール送信システム - 管理画面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #000000;
        }

        /* ログイン画面 */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            border: 2px solid #000;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #000;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 10px 20px;
            background: #000;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn:hover {
            background: #333;
        }

        .btn-secondary {
            background: #fff;
            color: #000;
            border: 1px solid #000;
        }

        .btn-secondary:hover {
            background: #f0f0f0;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* メインレイアウト */
        .main-container {
            display: none;
        }

        .main-container.active {
            display: flex;
            min-height: 100vh;
        }

        /* サイドバー */
        .sidebar {
            width: 250px;
            background: #000;
            color: #fff;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #333;
        }

        .sidebar-header h2 {
            font-size: 18px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-menu li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sidebar-menu li:hover {
            background: #333;
        }

        .sidebar-menu li.active {
            background: #fff;
            color: #000;
        }

        .logout-btn {
            margin: 20px;
        }

        /* ハンバーガーメニュー */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 200;
            background: #000;
            color: #fff;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 24px;
            transition: opacity 0.3s ease;
        }

        .hamburger:hover {
            background: #333;
        }

        .hamburger.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }

        .mobile-overlay.active {
            display: block;
        }

        /* コンテンツエリア */
        .content {
            margin-left: 250px;
            padding: 30px;
            flex: 1;
        }

        .content-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .content-header h1 {
            font-size: 28px;
        }

        /* カード */
        .card {
            background: #fff;
            border: 1px solid #000;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .card-header h2 {
            font-size: 20px;
        }

        /* テーブル */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #000;
            color: #fff;
            font-weight: 600;
        }

        table tr:hover {
            background: #f5f5f5;
        }

        /* フィルター */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn.active {
            background: #000;
            color: #fff;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border: 2px solid #000;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #000;
        }

        .modal-header h2 {
            font-size: 22px;
        }

        .close-btn {
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            border: none;
            background: none;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* バッジ */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #000;
        }

        .badge-pending {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .badge-approved {
            background: #d4edda;
            border-color: #28a745;
        }

        .badge-rejected {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .badge-cancelled {
            background: #e2e3e5;
            border-color: #6c757d;
        }

        /* アクションボタン */
        .action-btns {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
        }

        .action-btn:hover {
            background: #f0f0f0;
        }

        /* プランカード */
        .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .plan-card {
            border: 2px solid #000;
            padding: 20px;
        }

        .plan-card h3 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .plan-details {
            margin: 15px 0;
        }

        .plan-details p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .plan-details strong {
            font-weight: 600;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content {
                margin-left: 0;
                padding: 80px 20px 30px;
            }

            .main-container {
                flex-direction: column;
            }

            .plan-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-btn {
                width: 100%;
            }

            table {
                font-size: 12px;
            }

            table th,
            table td {
                padding: 8px;
            }

            .modal-content {
                padding: 20px;
            }
        }

        .hidden {
            display: none;
        }

        .info-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            width: 150px;
        }

        .info-value {
            flex: 1;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-top: 10px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>管理画面ログイン</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>ユーザーID</label>
                    <input type="text" id="loginId" required>
                </div>
                <div class="form-group">
                    <label>パスワード</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div id="loginError" class="error-message hidden"></div>
                <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">ログイン</button>
            </form>
        </div>
    </div>

    <!-- メイン管理画面 -->
    <div id="mainScreen" class="main-container">
        <!-- ハンバーガーメニューボタン -->
        <button class="hamburger" id="hamburgerBtn">☰</button>

        <!-- モバイル用オーバーレイ -->
        <div class="mobile-overlay" id="mobileOverlay"></div>

        <!-- サイドバー -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>管理画面</h2>
            </div>
            <ul class="sidebar-menu" id="sidebarMenu">
                <li data-page="applications" class="active">申請者管理</li>
                <li data-page="plans">プラン管理</li>
                <li data-page="history">送信履歴</li>
                <li data-page="manual-send">手動メール送信</li>
                <li data-page="settings">設定</li>
            </ul>
            <button class="btn logout-btn" id="logoutBtn">ログアウト</button>
        </div>

        <!-- コンテンツエリア -->
        <div class="content">
            <!-- 申請者管理 -->
            <div id="applications" class="page-content">
                <div class="content-header">
                    <h1>申請者管理</h1>
                </div>
                <div class="card">
                    <div class="filters" id="statusFilters">
                        <button class="filter-btn active" data-status="all">全て</button>
                        <button class="filter-btn" data-status="pending">承認待ち</button>
                        <button class="filter-btn" data-status="approved">承認済み</button>
                        <button class="filter-btn" data-status="rejected">却下</button>
                        <button class="filter-btn" data-status="cancelled">解約済み</button>
                    </div>
                    <div class="table-container">
                        <table id="applicationsTable">
                            <thead>
                                <tr>
                                    <th>会員番号</th>
                                    <th>氏名</th>
                                    <th>ステータス</th>
                                    <th>プラン</th>
                                    <th>申請日</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- プラン管理 -->
            <div id="plans" class="page-content hidden">
                <div class="content-header">
                    <h1>プラン管理</h1>
                </div>
                <button class="btn" id="addPlanBtn" style="margin-bottom: 20px;">新規プラン追加</button>
                <div class="plan-grid" id="planGrid"></div>
            </div>

            <!-- 送信履歴 -->
            <div id="history" class="page-content hidden">
                <div class="content-header">
                    <h1>メール送信履歴</h1>
                </div>
                <div class="card">
                    <div class="form-group" style="max-width: 300px; margin-bottom: 20px;">
                        <label>日付絞り込み</label>
                        <input type="date" id="historyDateFilter">
                    </div>
                    <div class="table-container">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th>送信日時</th>
                                    <th>プラン</th>
                                    <th>送信数</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 手動メール送信 -->
            <div id="manual-send" class="page-content hidden">
                <div class="content-header">
                    <h1>手動メール送信</h1>
                </div>
                <div class="card">
                    <form id="manualSendForm">
                        <div class="form-group">
                            <label>対象プラン</label>
                            <select id="manualSendPlan" required></select>
                        </div>
                        <div class="form-group">
                            <label>件名</label>
                            <input type="text" id="manualSendSubject" required>
                        </div>
                        <div class="form-group">
                            <label>本文</label>
                            <textarea id="manualSendBody" required placeholder="変数: {name-l}=姓, {name-f}=名, {birthday}=生年月日"></textarea>
                        </div>
                        <button type="submit" class="btn">送信</button>
                    </form>
                </div>
            </div>

            <!-- 設定 -->
            <div id="settings" class="page-content hidden">
                <div class="content-header">
                    <h1>設定</h1>
                </div>
                
                <div class="card">
                    <h2>パスワード変更</h2>
                    <form id="passwordChangeForm">
                        <div class="form-group">
                            <label>ユーザーID</label>
                            <input type="text" id="changePasswordUserId" required>
                        </div>
                        <div class="form-group">
                            <label>現在のパスワード</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label>新しいパスワード</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div id="passwordChangeMessage" class="hidden"></div>
                        <button type="submit" class="btn">変更</button>
                    </form>
                </div>

                <div class="card">
                    <h2>OpenAI API 設定</h2>
                    <form id="openaiApiForm">
                        <div class="form-group">
                            <label>OpenAI API Key</label>
                            <input type="text" id="openaiApiKey" placeholder="sk-...">
                            <small>GPTでメール本文を自動生成するために必要です。設定画面から安全に変更できます。</small>
                        </div>
                        <div id="openaiApiMessage" class="hidden"></div>
                        <button type="submit" class="btn">保存</button>
                    </form>
                </div>

                <div class="card">
                    <h2>メールテンプレート設定</h2>
                    <form id="emailTemplateForm">
                        <div class="form-group">
                            <label>デフォルト件名</label>
                            <input type="text" id="emailSubject" placeholder="【お知らせ】本日の配信">
                        </div>
                        <div class="form-group">
                            <label>デフォルト本文テンプレート</label>
                            <textarea id="emailBody" placeholder="{name-l}{name-f}様&#10;&#10;本日の配信内容:&#10;{{content}}"></textarea>
                            <small>変数: {name-l}=姓, {name-f}=名, {birthday}=生年月日, {{content}}=GPT生成内容</small>
                        </div>
                        <button type="submit" class="btn">保存</button>
                    </form>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>スタッフ管理</h2>
                        <button class="btn" id="addStaffBtn">スタッフ追加</button>
                    </div>
                    <div class="table-container">
                        <table id="staffTable">
                            <thead>
                                <tr>
                                    <th>氏名</th>
                                    <th>メールアドレス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 申請者詳細モーダル -->
    <div id="applicationDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>申請者詳細</h2>
                <button class="close-btn" id="closeAppDetailBtn">&times;</button>
            </div>
            <div class="modal-body" id="applicationDetailBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeAppDetailBtn2">閉じる</button>
            </div>
        </div>
    </div>

    <!-- プラン追加/編集モーダル -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="planModalTitle">プラン追加</h2>
                <button class="close-btn" id="closePlanModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planId">
                    <div class="form-group">
                        <label>プラン名</label>
                        <input type="text" id="planName" required>
                    </div>
                    <div class="form-group">
                        <label>プロンプトテンプレート</label>
                        <textarea id="planPrompt" required placeholder="変数: {name-l}=姓, {name-f}=名, {birthday}=生年月日"></textarea>
                    </div>
                    <div class="form-group">
    <label>使用モデル</label>
    <select id="planModel" required>
        <optgroup label="GPT-5シリーズ（最新）">
            <option value="gpt-5">GPT-5</option>
            <option value="gpt-5-chat-latest">GPT-5 Chat Latest</option>
            <option value="gpt-5-mini">GPT-5 Mini</option>
            <option value="gpt-5-nano">GPT-5 Nano</option>
        </optgroup>
        <optgroup label="o1シリーズ（推論モデル）">
            <option value="o1-preview">o1-preview</option>
            <option value="o1-mini">o1-mini</option>
        </optgroup>
        <optgroup label="GPT-4oシリーズ">
            <option value="gpt-4o">GPT-4o</option>
            <option value="gpt-4o-mini">GPT-4o-mini</option>
            <option value="gpt-4-turbo">GPT-4 Turbo</option>
        </optgroup>
        <optgroup label="旧モデル">
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        </optgroup>
    </select>
</div>
                    <div class="form-group">
                        <label>メール送信時刻</label>
                        <input type="time" id="planSendTime" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closePlanModalBtn2">キャンセル</button>
                <button class="btn" id="savePlanBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- プラン詳細モーダル -->
    <div id="planDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="planDetailTitle">プラン詳細</h2>
                <button class="close-btn" id="closePlanDetailBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="planDetailInfo" style="margin-bottom: 20px;"></div>
                
                <h3 style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #000;">加入者一覧</h3>
                
                <div class="form-group" style="max-width: 400px; margin-bottom: 20px;">
                    <label>検索（名前・会員番号）</label>
                    <input type="text" id="planCustomerSearch" placeholder="山田太郎 または NOTE-2024-0001">
                </div>
                
                <div class="table-container">
                    <table id="planCustomersTable">
                        <thead>
                            <tr>
                                <th>会員番号</th>
                                <th>氏名</th>
                                <th>メールアドレス</th>
                                <th>登録日</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="editPlanFromDetail()" id="editPlanFromDetailBtn">編集</button>
                <button class="btn btn-secondary" id="closePlanDetailBtn2">閉じる</button>
            </div>
        </div>
    </div>

    <!-- スタッフ追加/編集モーダル -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="staffModalTitle">スタッフ追加</h2>
                <button class="close-btn" id="closeStaffModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId">
                    <div class="form-group">
                        <label>氏名</label>
                        <input type="text" id="staffName" required>
                    </div>
                    <div class="form-group">
                        <label>メールアドレス</label>
                        <input type="email" id="staffEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeStaffModalBtn2">キャンセル</button>
                <button class="btn" id="saveStaffBtn">保存</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // 設定
        // ========================================
       const API_BASE_URL = 'https://gpts-email-system-460540063355.asia-northeast1.run.app';
        
        // 認証トークン
        let authToken = localStorage.getItem('authToken') || null;
        
        // グローバル変数
        let currentFilter = 'all';
        let currentPlanId = null;

        // ========================================
        // ユーティリティ関数
        // ========================================
        
        // API呼び出しヘルパー
        async function apiCall(endpoint, method = 'GET', data = null, requireAuth = true) {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (requireAuth && authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            const options = {
                method: method,
                headers: headers
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (response.status === 401) {
                    // 認証エラー - ログアウト
                    logout();
                    throw new Error('認証エラー。再度ログインしてください。');
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'エラーが発生しました');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // ステータステキスト取得
        function getStatusText(status) {
            const statusMap = {
                'pending': '承認待ち',
                'approved': '承認済み',
                'rejected': '却下',
                'cancelled': '解約済み'
            };
            return statusMap[status] || status;
        }
        
        // ログアウト処理
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').classList.remove('active');
            document.getElementById('loginForm').reset();
        }

        // ========================================
        // 認証
        // ========================================
        
        // ログイン
        async function handleLogin(event) {
            event.preventDefault();
            
            const userId = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';
            
            try {
                const response = await apiCall('/api/auth/login', 'POST', {
                    userId: userId,
                    password: password
                }, false);
                
                authToken = response.token;
                localStorage.setItem('authToken', authToken);
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').classList.add('active');
                loadApplications();
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        }
        
        // パスワード変更
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const userId = document.getElementById('changePasswordUserId').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const messageDiv = document.getElementById('passwordChangeMessage');
            
            messageDiv.classList.add('hidden');
            messageDiv.textContent = '';
            
            try {
                await apiCall('/api/auth/change-password', 'POST', {
                    userId: userId,
                    currentPassword: currentPassword,
                    newPassword: newPassword
                });
                
                messageDiv.textContent = 'パスワードを変更しました';
                messageDiv.className = 'success-message';
                document.getElementById('passwordChangeForm').reset();
            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'error-message';
            }
        }

        // ========================================
        // 申請者管理
        // ========================================
        
        // 申請者一覧読み込み
        async function loadApplications(filterStatus = 'all') {
            currentFilter = filterStatus;
            const tbody = document.querySelector('#applicationsTable tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">読み込み中...</td></tr>';
            
            try {
                const queryParam = filterStatus !== 'all' ? `?status=${filterStatus}` : '';
                const applications = await apiCall(`/api/applications${queryParam}`);
                
                tbody.innerHTML = '';
                
                if (applications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">申請者がいません</td></tr>';
                    return;
                }
                
                applications.forEach(app => {
                    const tr = document.createElement('tr');
                    tr.style.cursor = 'pointer';
                    
                    let actionButtons = '';
                    if (app.status === 'pending') {
                        actionButtons = `
                            <button class="action-btn" onclick="updateApplicationStatus('${app.id}', 'approved')">承認</button>
                            <button class="action-btn" onclick="updateApplicationStatus('${app.id}', 'rejected')">却下</button>
                        `;
                    } else if (app.status === 'rejected') {
                        actionButtons = `
                            <button class="action-btn" onclick="updateApplicationStatus('${app.id}', 'approved')">承認</button>
                        `;
                    } else if (app.status === 'approved') {
                        actionButtons = `
                            <button class="action-btn btn-danger" onclick="cancelSubscription('${app.id}')">解約</button>
                        `;
                    }
                    
                    const fullName = `${app.lastName || ''} ${app.firstName || ''}`;
                    
                    tr.innerHTML = `
                        <td>${app.memberNumber}</td>
                        <td>${fullName}</td>
                        <td><span class="badge badge-${app.status}">${getStatusText(app.status)}</span></td>
                        <td>${app.plan}</td>
                        <td>${app.appliedDate}</td>
                        <td class="action-btns" onclick="event.stopPropagation()">
                            ${actionButtons}
                        </td>
                    `;
                    tr.onclick = function() { showApplicationDetail(app.id); };
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // 申請者詳細表示
        async function showApplicationDetail(id) {
            try {
                const app = await apiCall(`/api/applications/${id}`);
                
                const detailBody = document.getElementById('applicationDetailBody');
                const fullName = `${app.lastName || ''} ${app.firstName || ''}`;
                
                detailBody.innerHTML = `
                    <div class="info-row">
                        <div class="info-label">会員番号:</div>
                        <div class="info-value">${app.memberNumber}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">氏名:</div>
                        <div class="info-value">${fullName}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">姓:</div>
                        <div class="info-value">${app.lastName || ''}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">名:</div>
                        <div class="info-value">${app.firstName || ''}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">生年月日:</div>
                        <div class="info-value">${app.birthDate}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">メールアドレス:</div>
                        <div class="info-value">${app.email}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">プラン:</div>
                        <div class="info-value">${app.plan}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">ステータス:</div>
                        <div class="info-value"><span class="badge badge-${app.status}">${getStatusText(app.status)}</span></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">申請日:</div>
                        <div class="info-value">${app.appliedDate}</div>
                    </div>
                    ${app.lastSendDate ? `
                    <div class="info-row">
                        <div class="info-label">最終送信日:</div>
                        <div class="info-value">${app.lastSendDate}</div>
                    </div>
                    ` : ''}
                `;
                document.getElementById('applicationDetailModal').classList.add('active');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // 申請ステータス更新
        async function updateApplicationStatus(id, newStatus) {
            try {
                await apiCall(`/api/applications/${id}/status`, 'PUT', {
                    status: newStatus
                });
                
                loadApplications(currentFilter);
                alert(`申請を${getStatusText(newStatus)}しました`);
            } catch (error) {
                alert(error.message);
            }
        }
        
        // 解約処理
        async function cancelSubscription(id) {
            const lastSendDate = prompt('最終送信日を入力してください（YYYY-MM-DD形式）:');
            
            if (!lastSendDate) {
                return;
            }
            
            const datePattern = /^\d{4}-\d{2}-\d{2}$/;
            if (!datePattern.test(lastSendDate)) {
                alert('日付の形式が正しくありません。YYYY-MM-DD形式で入力してください。');
                return;
            }
            
            try {
                await apiCall(`/api/applications/${id}/status`, 'PUT', {
                    status: 'cancelled',
                    lastSendDate: lastSendDate
                });
                
                if (document.getElementById('planDetailModal').classList.contains('active')) {
                    const planName = document.getElementById('planDetailTitle').textContent.replace(' - 詳細', '');
                    loadPlanCustomers(currentPlanId);
                }
                
                loadApplications(currentFilter);
                alert(`解約処理が完了しました。最終送信日: ${lastSendDate}`);
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // プラン管理
        // ========================================
        let isSavingPlan = false;
        // プラン一覧読み込み
        async function loadPlans() {
            const planGrid = document.getElementById('planGrid');
            planGrid.innerHTML = '<p style="padding: 20px;">読み込み中...</p>';
            
            try {
                const plans = await apiCall('/api/plans');
                
                planGrid.innerHTML = '';
                
                if (plans.length === 0) {
                    planGrid.innerHTML = '<p style="padding: 20px;">プランがありません</p>';
                    return;
                }
                
                plans.forEach(plan => {
                    const planCard = document.createElement('div');
                    planCard.className = 'plan-card';
                    planCard.style.cursor = 'pointer';
                    planCard.innerHTML = `
                        <h3>${plan.name}</h3>
                        <div class="plan-details">
                            <p><strong>使用モデル:</strong> ${plan.model}</p>
                            <p><strong>送信時刻:</strong> ${plan.sendTime}</p>
                            <p><strong>プロンプト:</strong></p>
                            <p style="font-size: 13px; color: #666;">${plan.prompt.substring(0, 100)}...</p>
                        </div>
                        <div class="plan-actions">
                            <button class="btn" onclick="event.stopPropagation(); showPlanDetail('${plan.id}')" style="background: #007bff;">詳細</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deletePlan('${plan.id}')">削除</button>
                        </div>
                    `;
                    planCard.onclick = function() { showPlanDetail(plan.id); };
                    planGrid.appendChild(planCard);
                });
            } catch (error) {
                planGrid.innerHTML = `<p style="padding: 20px; color: #dc3545;">${error.message}</p>`;
            }
        }
        
        // プラン詳細表示
        async function showPlanDetail(planId) {
            try {
                const plan = await apiCall(`/api/plans/${planId}`);
                
                currentPlanId = planId;
                
                document.getElementById('planDetailTitle').textContent = `${plan.name} - 詳細`;
                
                const planDetailInfo = document.getElementById('planDetailInfo');
                planDetailInfo.innerHTML = `
                    <div class="info-row">
                        <div class="info-label">プラン名:</div>
                        <div class="info-value">${plan.name}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">使用モデル:</div>
                        <div class="info-value">${plan.model}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">送信時刻:</div>
                        <div class="info-value">${plan.sendTime}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">プロンプト:</div>
                        <div class="info-value" style="white-space: pre-wrap;">${plan.prompt}</div>
                    </div>
                `;
                
                loadPlanCustomers(planId);
                
                document.getElementById('planDetailModal').classList.add('active');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // プラン加入者一覧読み込み
        async function loadPlanCustomers(planId, searchQuery = '') {
            const tbody = document.querySelector('#planCustomersTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">読み込み中...</td></tr>';
            
            try {
                const queryParam = searchQuery ? `?search=${encodeURIComponent(searchQuery)}` : '';
                const subscribers = await apiCall(`/api/plans/${planId}/subscribers${queryParam}`);
                
                tbody.innerHTML = '';
                
                if (subscribers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">該当する加入者がいません</td></tr>';
                    return;
                }
                
                subscribers.forEach(customer => {
                    const tr = document.createElement('tr');
                    const fullName = `${customer.lastName || ''} ${customer.firstName || ''}`;
                    
                    tr.innerHTML = `
                        <td>${customer.memberNumber}</td>
                        <td>${fullName}</td>
                        <td>${customer.email}</td>
                        <td>${customer.appliedDate}</td>
                        <td>
                            <button class="action-btn btn-danger" onclick="cancelSubscription('${customer.id}')">解約</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // プラン追加モーダル表示
        function showAddPlanModal() {
            document.getElementById('planModalTitle').textContent = 'プラン追加';
            document.getElementById('planForm').reset();
            document.getElementById('planId').value = '';
            document.getElementById('planModal').classList.add('active');
        }
        
        // プラン編集
        async function editPlan(id) {
            try {
                const plan = await apiCall(`/api/plans/${id}`);
                
                document.getElementById('planModalTitle').textContent = 'プラン編集';
                document.getElementById('planId').value = plan.id;
                document.getElementById('planName').value = plan.name;
                document.getElementById('planPrompt').value = plan.prompt;
                document.getElementById('planModel').value = plan.model;
                document.getElementById('planSendTime').value = plan.sendTime;
                document.getElementById('planModal').classList.add('active');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // プラン詳細から編集
        function editPlanFromDetail() {
            if (currentPlanId) {
                document.getElementById('planDetailModal').classList.remove('active');
                editPlan(currentPlanId);
            }
        }
        
        // プラン保存
        async function savePlan() {
            // 連打防止チェック
            if (isSavingPlan) {
                console.log('既に保存処理中です');
                return;
            }
    
            const id = document.getElementById('planId').value;
            const name = document.getElementById('planName').value;
            const prompt = document.getElementById('planPrompt').value;
            const model = document.getElementById('planModel').value;
            const sendTime = document.getElementById('planSendTime').value;

            if (!name || !prompt || !model || !sendTime) {
                alert('全ての項目を入力してください');
                return;
            }

            // 保存中フラグをON
            isSavingPlan = true;
    
            // ボタンを無効化
            const saveBtn = document.getElementById('savePlanBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '保存中...';
            saveBtn.disabled = true;
            saveBtn.classList.add('loading');

            try {
                if (id) {
                    await apiCall(`/api/plans/${id}`, 'PUT', {
                        name, prompt, model, sendTime
                    });
                } else {
                    await apiCall('/api/plans', 'POST', {
                        name, prompt, model, sendTime
                    });
                }
        
                document.getElementById('planModal').classList.remove('active');
                loadPlans();
                alert('プランを保存しました');
            } catch (error) {
                alert(error.message);
            } finally {
                // 保存中フラグをOFF
                isSavingPlan = false;
        
                // ボタンを元に戻す
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
            }
        }
        
        // プラン削除
        async function deletePlan(id) {
            if (!confirm('このプランを削除してもよろしいですか?')) {
                return;
            }
            
            try {
                await apiCall(`/api/plans/${id}`, 'DELETE');
                loadPlans();
                alert('プランを削除しました');
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // 送信履歴
        // ========================================
        
        // 送信履歴読み込み
        async function loadHistory(filterDate = null) {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">読み込み中...</td></tr>';
            
            try {
                const queryParam = filterDate ? `?date=${filterDate}` : '';
                const history = await apiCall(`/api/history${queryParam}`);
                
                tbody.innerHTML = '';
                
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">履歴がありません</td></tr>';
                    return;
                }
                
                history.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.plan}</td>
                        <td>${item.count}件</td>
                        <td>${item.status}</td>
                        <td>
                            <button class="action-btn btn-danger" onclick="deleteHistory('${item.id}')">削除</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // 履歴削除
        async function deleteHistory(id) {
            if (!confirm('この履歴を削除してもよろしいですか?')) {
                return;
            }
            
            try {
                await apiCall(`/api/history/${id}`, 'DELETE');
                loadHistory();
                alert('履歴を削除しました');
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // 手動メール送信
        // ========================================
        
        // 手動メール送信画面読み込み
        async function loadManualSend() {
            const select = document.getElementById('manualSendPlan');
            select.innerHTML = '<option value="">読み込み中...</option>';
            
            try {
                const plans = await apiCall('/api/plans');
                
                select.innerHTML = '';
                
                if (plans.length === 0) {
                    select.innerHTML = '<option value="">プランがありません</option>';
                    return;
                }
                
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.id;
                    option.textContent = plan.name;
                    select.appendChild(option);
                });
            } catch (error) {
                select.innerHTML = `<option value="">エラー: ${error.message}</option>`;
            }
        }
        
        // 手動メール送信
        async function handleManualSend(event) {
            event.preventDefault();
            
            const planId = document.getElementById('manualSendPlan').value;
            const subject = document.getElementById('manualSendSubject').value;
            const body = document.getElementById('manualSendBody').value;
            
            if (!confirm('選択したプランの全加入者にメールを送信しますか?')) {
                return;
            }
            
            try {
                const result = await apiCall('/api/send-manual', 'POST', {
                    planId, subject, body
                });
                
                alert(result.message);
                document.getElementById('manualSendForm').reset();
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // 設定
        // ========================================
        
        // 設定読み込み
        async function loadSettings() {
            try {
                const settings = await apiCall('/api/settings');
                
                document.getElementById('emailSubject').value = settings.emailSubject || '';
                document.getElementById('emailBody').value = settings.emailBody || '';
                document.getElementById('openaiApiKey').value = settings.openaiApiKey || '';
                
                await loadStaff();
            } catch (error) {
                console.error('設定読み込みエラー:', error);
            }
        }
        
        // OpenAI API Key保存
        async function handleOpenAIApiSave(event) {
            event.preventDefault();
            
            const openaiApiKey = document.getElementById('openaiApiKey').value;
            const messageDiv = document.getElementById('openaiApiMessage');
            
            messageDiv.classList.add('hidden');
            messageDiv.textContent = '';
            
            try {
                await apiCall('/api/settings', 'PUT', {
                    openaiApiKey: openaiApiKey
                });
                
                messageDiv.textContent = 'OpenAI API Keyを保存しました';
                messageDiv.className = 'success-message';
            } catch (error) {
                messageDiv.textContent = error.message;
                messageDiv.className = 'error-message';
            }
        }
        
        // メールテンプレート保存
        async function handleEmailTemplateSave(event) {
            event.preventDefault();
            
            const emailSubject = document.getElementById('emailSubject').value;
            const emailBody = document.getElementById('emailBody').value;
            
            try {
                await apiCall('/api/settings', 'PUT', {
                    emailSubject, emailBody
                });
                
                alert('メールテンプレートを保存しました');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // スタッフ一覧読み込み
        async function loadStaff() {
            const tbody = document.querySelector('#staffTable tbody');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">読み込み中...</td></tr>';
            
            try {
                const staff = await apiCall('/api/staff');
                
                tbody.innerHTML = '';
                
                if (staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">スタッフが登録されていません</td></tr>';
                    return;
                }
                
                staff.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${s.name}</td>
                        <td>${s.email}</td>
                        <td class="action-btns">
                            <button class="action-btn" onclick="editStaff('${s.id}')">編集</button>
                            <button class="action-btn btn-danger" onclick="deleteStaff('${s.id}')">削除</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: #dc3545;">${error.message}</td></tr>`;
            }
        }
        
        // スタッフ追加モーダル表示
        function showAddStaffModal() {
            document.getElementById('staffModalTitle').textContent = 'スタッフ追加';
            document.getElementById('staffForm').reset();
            document.getElementById('staffId').value = '';
            document.getElementById('staffModal').classList.add('active');
        }
        
        // スタッフ編集
        async function editStaff(id) {
            try {
                const staff = await apiCall('/api/staff');
                const member = staff.find(s => s.id === id);
                
                if (member) {
                    document.getElementById('staffModalTitle').textContent = 'スタッフ編集';
                    document.getElementById('staffId').value = member.id;
                    document.getElementById('staffName').value = member.name;
                    document.getElementById('staffEmail').value = member.email;
                    document.getElementById('staffModal').classList.add('active');
                }
            } catch (error) {
                alert(error.message);
            }
        }
        
        // スタッフ保存
        async function saveStaff() {
            const id = document.getElementById('staffId').value;
            const name = document.getElementById('staffName').value;
            const email = document.getElementById('staffEmail').value;

            if (!name || !email) {
                alert('全ての項目を入力してください');
                return;
            }

            try {
                if (id) {
                    await apiCall(`/api/staff/${id}`, 'PUT', { name, email });
                } else {
                    await apiCall('/api/staff', 'POST', { name, email });
                }
                
                document.getElementById('staffModal').classList.remove('active');
                loadStaff();
                alert('スタッフ情報を保存しました');
            } catch (error) {
                alert(error.message);
            }
        }
        
        // スタッフ削除
        async function deleteStaff(id) {
            if (!confirm('このスタッフを削除してもよろしいですか?')) {
                return;
            }
            
            try {
                await apiCall(`/api/staff/${id}`, 'DELETE');
                loadStaff();
                alert('スタッフを削除しました');
            } catch (error) {
                alert(error.message);
            }
        }

        // ========================================
        // ページ切り替え
        // ========================================
        
        function switchPage(pageName) {
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(pageName).classList.remove('hidden');

            switch(pageName) {
                case 'applications':
                    loadApplications();
                    break;
                case 'plans':
                    loadPlans();
                    break;
                case 'history':
                    loadHistory();
                    break;
                case 'manual-send':
                    loadManualSend();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // ========================================
        // 初期化
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // トークンチェック
            if (authToken) {
                // 既にログイン済み
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').classList.add('active');
                loadApplications();
            }
            
            // ハンバーガーメニュー
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');

            hamburgerBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                hamburgerBtn.classList.toggle('hidden');
            });

            mobileOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                mobileOverlay.classList.remove('active');
                hamburgerBtn.classList.remove('hidden');
            });

            // サイドバーメニュー
            document.querySelectorAll('#sidebarMenu li').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    switchPage(page);
                    
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                        mobileOverlay.classList.remove('active');
                        hamburgerBtn.classList.remove('hidden');
                    }
                });
            });

            // ログインフォーム
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // ログアウト
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('ログアウトしますか?')) {
                    logout();
                }
            });

            // パスワード変更
            document.getElementById('passwordChangeForm').addEventListener('submit', handlePasswordChange);

            // OpenAI API設定
            document.getElementById('openaiApiForm').addEventListener('submit', handleOpenAIApiSave);

            // フィルターボタン
            document.querySelectorAll('#statusFilters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#statusFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadApplications(this.getAttribute('data-status'));
                });
            });

            // プラン関連
            document.getElementById('addPlanBtn').addEventListener('click', showAddPlanModal);
            document.getElementById('savePlanBtn').addEventListener('click', savePlan);
            document.getElementById('closePlanModalBtn').addEventListener('click', function() {
                document.getElementById('planModal').classList.remove('active');
            });
            document.getElementById('closePlanModalBtn2').addEventListener('click', function() {
                document.getElementById('planModal').classList.remove('active');
            });

            // 申請者詳細モーダル
            document.getElementById('closeAppDetailBtn').addEventListener('click', function() {
                document.getElementById('applicationDetailModal').classList.remove('active');
            });
            document.getElementById('closeAppDetailBtn2').addEventListener('click', function() {
                document.getElementById('applicationDetailModal').classList.remove('active');
            });

            // プラン詳細モーダル
            document.getElementById('closePlanDetailBtn').addEventListener('click', function() {
                document.getElementById('planDetailModal').classList.remove('active');
            });
            document.getElementById('closePlanDetailBtn2').addEventListener('click', function() {
                document.getElementById('planDetailModal').classList.remove('active');
            });

            // プラン加入者検索
            document.getElementById('planCustomerSearch').addEventListener('input', function() {
                if (currentPlanId) {
                    loadPlanCustomers(currentPlanId, this.value);
                }
            });

            // スタッフ関連
            document.getElementById('addStaffBtn').addEventListener('click', showAddStaffModal);
            document.getElementById('saveStaffBtn').addEventListener('click', saveStaff);
            document.getElementById('closeStaffModalBtn').addEventListener('click', function() {
                document.getElementById('staffModal').classList.remove('active');
            });
            document.getElementById('closeStaffModalBtn2').addEventListener('click', function() {
                document.getElementById('staffModal').classList.remove('active');
            });

            // 日付フィルター
            document.getElementById('historyDateFilter').addEventListener('change', function() {
                loadHistory(this.value);
            });

            // 手動メール送信
            document.getElementById('manualSendForm').addEventListener('submit', handleManualSend);

            // メールテンプレート保存
            document.getElementById('emailTemplateForm').addEventListener('submit', handleEmailTemplateSave);
        });
    </script>
</body>
</html>
